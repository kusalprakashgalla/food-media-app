{"ast":null,"code":"/**\n * Authorization Token\n * @module auth_token\n */\n\nvar crypto = require('crypto');\nvar smart_escape = require('./utils/encoding/smart_escape');\nvar unsafe = /([ \"#%&'/:;<=>?@[\\]^`{|}~]+)/g;\nfunction digest(message, key) {\n  return crypto.createHmac(\"sha256\", Buffer.from(key, \"hex\")).update(message).digest('hex');\n}\n\n/**\n * Escape url using lowercase hex code\n * @param {string} url a url string\n * @return {string} escaped url\n */\nfunction escapeToLower(url) {\n  var safeUrl = smart_escape(url, unsafe);\n  return safeUrl.replace(/%../g, function (match) {\n    return match.toLowerCase();\n  });\n}\n\n/**\n * Auth token options\n * @typedef {object} authTokenOptions\n * @property {string} [token_name=\"__cld_token__\"] The name of the token.\n * @property {string} key The secret key required to sign the token.\n * @property {string} ip The IP address of the client.\n * @property {number} start_time=now The start time of the token in seconds from epoch.\n * @property {string} expiration The expiration time of the token in seconds from epoch.\n * @property {string} duration The duration of the token (from start_time).\n * @property {string|Array<string>} acl The ACL(s) for the token.\n * @property {string} url The URL to authentication in case of a URL token.\n *\n */\n\n/**\n * Generate an authorization token\n * @param {authTokenOptions} options\n * @returns {string} the authorization token\n */\nmodule.exports = function (options) {\n  var tokenName = options.token_name ? options.token_name : \"__cld_token__\";\n  var tokenSeparator = \"~\";\n  if (options.expiration == null) {\n    if (options.duration != null) {\n      var start = options.start_time != null ? options.start_time : Math.round(Date.now() / 1000);\n      options.expiration = start + options.duration;\n    } else {\n      throw new Error(\"Must provide either expiration or duration\");\n    }\n  }\n  var tokenParts = [];\n  if (options.ip != null) {\n    tokenParts.push(\"ip=\".concat(options.ip));\n  }\n  if (options.start_time != null) {\n    tokenParts.push(\"st=\".concat(options.start_time));\n  }\n  tokenParts.push(\"exp=\".concat(options.expiration));\n  if (options.acl != null) {\n    if (Array.isArray(options.acl) === true) {\n      options.acl = options.acl.join(\"!\");\n    }\n    tokenParts.push(\"acl=\".concat(escapeToLower(options.acl)));\n  }\n  var toSign = [].concat(tokenParts);\n  if (options.url != null && options.acl == null) {\n    var url = escapeToLower(options.url);\n    toSign.push(\"url=\".concat(url));\n  }\n  var auth = digest(toSign.join(tokenSeparator), options.key);\n  tokenParts.push(\"hmac=\".concat(auth));\n  if (!options.url && !options.acl) {\n    throw 'authToken must contain either an acl or a url property';\n  }\n  return \"\".concat(tokenName, \"=\").concat(tokenParts.join(tokenSeparator));\n};","map":null,"metadata":{},"sourceType":"script"}